{% extends "base.html" %}

{% block title %}Dashboard Super Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/personalizacion.css') }}">
<style>
.super-admin-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
    border-left: 4px solid #2a5298;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
}

.chart-card {
    background: white;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.quick-action-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
}

.quick-action-btn {
    width: 100%;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateX(5px);
}

.alert-item {
    padding: 1rem;
    border-left: 4px solid;
    margin-bottom: 0.75rem;
    border-radius: 4px;
    background: white;
}

.alert-critical { border-left-color: #dc3545; background: #fff5f5; }
.alert-warning { border-left-color: #ffc107; background: #fffbf0; }
.alert-info { border-left-color: #0dcaf0; background: #f0f9ff; }

.activity-item {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.activity-item:last-child {
    border-bottom: none;
}

.badge-role {
    padding: 0.35rem 0.65rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-bottom: 3px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #2a5298;
    border-bottom-color: #2a5298;
    background: none;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

.system-health {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.health-good { background-color: #28a745; }
.health-warning { background-color: #ffc107; }
.health-critical { background-color: #dc3545; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@media (max-width: 768px) {
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .chart-card {
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="super-admin-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-2"><i class="bi bi-shield-check"></i> Dashboard Super Admin</h2>
                <p class="mb-0" id="userInfo">Cargando información...</p>
                <div class="system-health mt-2">
                    <span class="health-indicator health-good" id="systemHealthIndicator"></span>
                    <small id="systemHealthText">Sistema operando normalmente</small>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-light me-2" onclick="window.syncManager && window.syncManager.syncAll()">
                    <i class="bi bi-arrow-repeat"></i> Sincronizar
                </button>
                <button class="btn btn-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </div>

    <!-- Alertas Críticas -->
    <div id="criticalAlertsContainer" class="mb-4" style="display: none;">
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle-fill"></i> Alertas Críticas</h5>
            <div id="criticalAlertsList"></div>
        </div>
    </div>

    <!-- Estadísticas Principales -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="stat-card">
                <div class="stat-icon text-primary"><i class="bi bi-people-fill"></i></div>
                <h3 id="totalUsuarios" class="mb-1">0</h3>
                <p class="text-muted mb-0">Usuarios Activos</p>
                <small class="text-success"><i class="bi bi-arrow-up"></i> <span id="usuariosChange">0</span> hoy</small>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stat-card">
                <div class="stat-icon text-info"><i class="bi bi-geo-alt-fill"></i></div>
                <h3 id="totalPuestos" class="mb-1">0</h3>
                <p class="text-muted mb-0">Puestos Electorales</p>
                <small class="text-muted"><span id="totalMesas">0</span> mesas</small>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stat-card">
                <div class="stat-icon text-warning"><i class="bi bi-file-earmark-text-fill"></i></div>
                <h3 id="totalFormularios" class="mb-1">0</h3>
                <p class="text-muted mb-0">Formularios E-14</p>
                <small class="text-info"><span id="formulariosPendientes">0</span> pendientes</small>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stat-card">
                <div class="stat-icon text-success"><i class="bi bi-check-circle-fill"></i></div>
                <h3 id="totalValidados" class="mb-1">0</h3>
                <p class="text-muted mb-0">Validados</p>
                <small class="text-success"><span id="porcentajeValidados">0</span>% completado</small>
            </div>
        </div>
    </div>

    <!-- Tabs de Navegación -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                <i class="bi bi-speedometer2"></i> Vista General
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="bi bi-people"></i> Usuarios
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">
                <i class="bi bi-gear"></i> Configuración
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button">
                <i class="bi bi-activity"></i> Monitoreo
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button">
                <i class="bi bi-journal-text"></i> Auditoría
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="incidents-tab" data-bs-toggle="tab" data-bs-target="#incidents" type="button">
                <i class="bi bi-exclamation-triangle"></i> Incidentes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="campanas-tab" data-bs-toggle="tab" data-bs-target="#campanas" type="button">
                <i class="bi bi-calendar-event"></i> Campañas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button">
                <i class="bi bi-upload"></i> Importar Datos
            </button>
        </li>
    </ul>

    <!-- Contenido de Tabs -->
    <div class="tab-content" id="adminTabsContent">
        
        <!-- Tab: Vista General -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                <!-- Gráficos -->
                <div class="col-md-8">
                    <div class="chart-card">
                        <h5 class="mb-3">Progreso Nacional de Recolección</h5>
                        <canvas id="progressChart" height="80"></canvas>
                    </div>
                    
                    <div class="chart-card">
                        <h5 class="mb-3">Actividad del Sistema (Últimas 24h)</h5>
                        <canvas id="activityChart" height="80"></canvas>
                    </div>
                </div>
                
                <!-- Panel Lateral -->
                <div class="col-md-4">
                    <!-- Acciones Rápidas -->
                    <div class="quick-action-card">
                        <h5 class="mb-3">Acciones Rápidas</h5>
                        <button class="btn btn-primary quick-action-btn" onclick="showCreateUserModal()">
                            <i class="bi bi-person-plus"></i> Crear Usuario
                        </button>
                        <button class="btn btn-info quick-action-btn" onclick="showConfigModal()">
                            <i class="bi bi-gear"></i> Configurar Sistema
                        </button>
                        <button class="btn btn-warning quick-action-btn" onclick="exportAllData()">
                            <i class="bi bi-download"></i> Exportar Datos
                        </button>
                        <button class="btn btn-success quick-action-btn" onclick="createBackup()">
                            <i class="bi bi-shield-check"></i> Crear Respaldo
                        </button>
                    </div>
                    
                    <!-- Testing y Auditoría -->
                    <div class="quick-action-card">
                        <h5 class="mb-3"><i class="bi bi-bug"></i> Testing & Diagnóstico</h5>
                        <button class="btn btn-outline-primary quick-action-btn" onclick="loadTestData()">
                            <i class="bi bi-database-add"></i> Cargar Datos de Prueba
                        </button>
                        <button class="btn btn-outline-info quick-action-btn" onclick="runSystemAudit()">
                            <i class="bi bi-clipboard-check"></i> Auditoría del Sistema
                        </button>
                        <button class="btn btn-outline-success quick-action-btn" onclick="runDiagnostico()">
                            <i class="bi bi-heart-pulse"></i> Diagnóstico del Sistema
                        </button>
                        <button class="btn btn-outline-warning quick-action-btn" onclick="fixRoles()">
                            <i class="bi bi-person-badge"></i> Corregir Roles
                        </button>
                        <button class="btn btn-outline-warning quick-action-btn" onclick="fixPasswords()">
                            <i class="bi bi-key"></i> Arreglar Contraseñas
                        </button>
                        <button class="btn btn-outline-danger quick-action-btn" onclick="resetDatabase()">
                            <i class="bi bi-arrow-clockwise"></i> Resetear Base de Datos
                        </button>
                    </div>
                    
                    <!-- Actividad Reciente -->
                    <div class="chart-card">
                        <h5 class="mb-3">Actividad Reciente</h5>
                        <div id="recentActivity" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted text-center">Cargando actividad...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Usuarios -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Gestión de Usuarios</h5>
                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                        <i class="bi bi-person-plus"></i> Nuevo Usuario
                    </button>
                </div>
                
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="filterRole" onchange="filterUsers()">
                            <option value="">Todos los roles</option>
                            <option value="testigo_electoral">Testigo Electoral</option>
                            <option value="coordinador_puesto">Coordinador Puesto</option>
                            <option value="coordinador_municipal">Coordinador Municipal</option>
                            <option value="coordinador_departamental">Coordinador Departamental</option>
                            <option value="auditor_electoral">Auditor Electoral</option>
                            <option value="super_admin">Super Admin</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus" onchange="filterUsers()">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activos</option>
                            <option value="inactivo">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchUser" placeholder="Buscar por nombre..." onkeyup="filterUsers()">
                    </div>
                </div>
                
                <!-- Tabla de Usuarios -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>Ubicación</th>
                                <th>Estado</th>
                                <th>Último Acceso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Configuración -->
        <div class="tab-pane fade" id="config" role="tabpanel">
            
            <!-- Sección de Carga Masiva -->
            <div class="chart-card mb-4">
                <h5 class="mb-3"><i class="bi bi-cloud-upload"></i> Carga Masiva de Datos</h5>
                <p class="text-muted">Cargue datos masivamente desde archivos Excel (.xlsx, .xls)</p>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="card border-primary mb-3">
                            <div class="card-body text-center">
                                <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                                <h6 class="mt-2">Usuarios</h6>
                                <p class="small text-muted">Testigos y Coordinadores</p>
                                <input type="file" id="uploadUsersFile" accept=".xlsx,.xls" style="display:none" onchange="uploadUsers(this)">
                                <button class="btn btn-sm btn-primary" onclick="document.getElementById('uploadUsersFile').click()">
                                    <i class="bi bi-upload"></i> Cargar
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="downloadTemplateUsers()">
                                    <i class="bi bi-download"></i> Plantilla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border-success mb-3">
                            <div class="card-body text-center">
                                <i class="bi bi-geo-alt-fill text-success" style="font-size: 2rem;"></i>
                                <h6 class="mt-2">DIVIPOLA</h6>
                                <p class="small text-muted">Ubicaciones Geográficas</p>
                                <input type="file" id="uploadLocationsFile" accept=".xlsx,.xls" style="display:none" onchange="uploadLocations(this)">
                                <button class="btn btn-sm btn-success" onclick="document.getElementById('uploadLocationsFile').click()">
                                    <i class="bi bi-upload"></i> Cargar
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="downloadTemplateLocations()">
                                    <i class="bi bi-download"></i> Plantilla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border-warning mb-3">
                            <div class="card-body text-center">
                                <i class="bi bi-flag-fill text-warning" style="font-size: 2rem;"></i>
                                <h6 class="mt-2">Partidos</h6>
                                <p class="small text-muted">Partidos Políticos</p>
                                <input type="file" id="uploadPartidosFile" accept=".xlsx,.xls" style="display:none" onchange="uploadPartidos(this)">
                                <button class="btn btn-sm btn-warning" onclick="document.getElementById('uploadPartidosFile').click()">
                                    <i class="bi bi-upload"></i> Cargar
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="downloadTemplatePartidos()">
                                    <i class="bi bi-download"></i> Plantilla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border-danger mb-3">
                            <div class="card-body text-center">
                                <i class="bi bi-person-badge-fill text-danger" style="font-size: 2rem;"></i>
                                <h6 class="mt-2">Candidatos</h6>
                                <p class="small text-muted">Candidatos Electorales</p>
                                <input type="file" id="uploadCandidatosFile" accept=".xlsx,.xls" style="display:none" onchange="uploadCandidatos(this)">
                                <button class="btn btn-sm btn-danger" onclick="document.getElementById('uploadCandidatosFile').click()">
                                    <i class="bi bi-upload"></i> Cargar
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="downloadTemplateCandidatos()">
                                    <i class="bi bi-download"></i> Plantilla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resultado de carga -->
                <div id="uploadResult" class="mt-3" style="display:none;">
                    <div class="alert" role="alert">
                        <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Resultado de Carga</h6>
                        <div id="uploadResultContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Configuración Manual -->
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3">Partidos Políticos</h5>
                        <button class="btn btn-sm btn-primary mb-3" onclick="showCreatePartyModal()">
                            <i class="bi bi-plus-circle"></i> Nuevo Partido
                        </button>
                        <div id="partiesList">
                            <p class="text-muted">Cargando partidos...</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3">Tipos de Elección</h5>
                        <button class="btn btn-sm btn-primary mb-3" onclick="createTipoEleccion()">
                            <i class="bi bi-plus-circle"></i> Nuevo Tipo
                        </button>
                        <div id="electionTypesList">
                            <p class="text-muted">Cargando tipos de elección...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-card mt-3">
                <h5 class="mb-3">Candidatos</h5>
                <button class="btn btn-sm btn-primary mb-3" onclick="showCreateCandidateModal()">
                    <i class="bi bi-plus-circle"></i> Nuevo Candidato
                </button>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Partido</th>
                                <th>Tipo Elección</th>
                                <th>Número Lista</th>
                                <th>Estado</th>
                                <th>Habilitar/Editar</th>
                            </tr>
                        </thead>
                        <tbody id="candidatesTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <p class="text-muted">Cargando candidatos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Monitoreo -->
        <div class="tab-pane fade" id="monitoring" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <div class="stat-card">
                        <h6 class="text-muted">Usuarios Conectados</h6>
                        <h2 id="connectedUsers">0</h2>
                        <small class="text-muted">En tiempo real</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <h6 class="text-muted">Requests/min</h6>
                        <h2 id="requestsPerMin">0</h2>
                        <small class="text-muted">Promedio últimos 5 min</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <h6 class="text-muted">Tiempo de Respuesta</h6>
                        <h2 id="avgResponseTime">0ms</h2>
                        <small class="text-muted">Promedio</small>
                    </div>
                </div>
            </div>
            
            <div class="chart-card">
                <h5 class="mb-3">Métricas del Sistema</h5>
                <canvas id="systemMetricsChart" height="80"></canvas>
            </div>
            
            <div class="chart-card">
                <h5 class="mb-3">Sesiones Activas</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>IP</th>
                                <th>Inicio Sesión</th>
                                <th>Última Actividad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="activeSessionsTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted">Cargando sesiones...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Auditoría -->
        <div class="tab-pane fade" id="audit" role="tabpanel">
            <div class="chart-card">
                <h5 class="mb-3">Logs de Auditoría</h5>
                
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="auditFilterUser" onchange="filterAuditLogs()">
                            <option value="">Todos los usuarios</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="auditFilterAction" onchange="filterAuditLogs()">
                            <option value="">Todas las acciones</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="create">Crear</option>
                            <option value="update">Actualizar</option>
                            <option value="delete">Eliminar</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="auditFilterDate" onchange="filterAuditLogs()">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="exportAuditLogs()">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <!-- Tabla de Logs -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acción</th>
                                <th>Recurso</th>
                                <th>Detalles</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted">Cargando logs...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Incidentes -->
        <div class="tab-pane fade" id="incidents" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="chart-card">
                        <h5 class="mb-3">Incidentes y Delitos Reportados</h5>
                        
                        <!-- Sub-tabs -->
                        <ul class="nav nav-pills mb-3">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#incidentsList">
                                    Incidentes (<span id="incidentsCount">0</span>)
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#crimesList">
                                    Delitos (<span id="crimesCount">0</span>)
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="incidentsList">
                                <div id="incidentsContainer">
                                    <p class="text-muted">Cargando incidentes...</p>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="crimesList">
                                <div id="crimesContainer">
                                    <p class="text-muted">Cargando delitos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="chart-card">
                        <h5 class="mb-3">Estadísticas</h5>
                        <canvas id="incidentsStatsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Campañas -->
        <div class="tab-pane fade" id="campanas" role="tabpanel">
            <div class="chart-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Gestión de Campañas</h5>
                    <button class="btn btn-primary" onclick="showCreateCampanaModal()">
                        <i class="bi bi-plus-circle"></i> Nueva Campaña
                    </button>
                </div>
                <p class="text-muted">Gestione múltiples campañas electorales independientes. Solo una campaña puede estar activa a la vez.</p>
                
                <div id="campanasContainer">
                    <p class="text-center text-muted">Cargando campañas...</p>
                </div>
            </div>
            
            <div class="chart-card">
                <h5 class="mb-3"><i class="bi bi-palette"></i> Temas y Colores</h5>
                <p class="text-muted">Configure temas visuales por rol o tipo de elección.</p>
                
                <button class="btn btn-sm btn-primary mb-3" onclick="showCreateTemaModal()">
                    <i class="bi bi-plus-circle"></i> Nuevo Tema
                </button>
                
                <div id="temasContainer">
                    <p class="text-center text-muted">Cargando temas...</p>
                </div>
            </div>
        </div>

        <!-- ⭐ NUEVA TAB: Importar Datos -->
        <div class="tab-pane fade" id="import" role="tabpanel">
            <div class="row">
                <!-- Importar Partidos -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="mb-3">
                            <i class="bi bi-flag"></i> Importar Partidos Políticos
                        </h5>
                        <p class="text-muted">Cargue partidos desde archivo CSV con información territorial.</p>
                        
                        <div class="mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="descargarTemplatePartidos()">
                                <i class="bi bi-download"></i> Descargar Plantilla CSV
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Archivo CSV de Partidos:</label>
                            <input type="file" class="form-control" id="filePartidos" accept=".csv">
                        </div>
                        
                        <button class="btn btn-success" onclick="importarPartidos()">
                            <i class="bi bi-upload"></i> Importar Partidos
                        </button>
                        
                        <div id="resultadoPartidos" class="mt-3"></div>
                    </div>
                </div>

                <!-- Importar Candidatos -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="mb-3">
                            <i class="bi bi-person-badge"></i> Importar Candidatos
                        </h5>
                        <p class="text-muted">Cargue candidatos por tipo de elección y territorio.</p>
                        
                        <div class="mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="descargarTemplateCandidatos()">
                                <i class="bi bi-download"></i> Descargar Plantilla CSV
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Archivo CSV de Candidatos:</label>
                            <input type="file" class="form-control" id="fileCandidatos" accept=".csv">
                        </div>
                        
                        <button class="btn btn-success" onclick="importarCandidatos()">
                            <i class="bi bi-upload"></i> Importar Candidatos
                        </button>
                        
                        <div id="resultadoCandidatos" class="mt-3"></div>
                    </div>
                </div>

                <!-- Subir Logos de Partidos -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="mb-3">
                            <i class="bi bi-image"></i> Logos de Partidos
                        </h5>
                        <p class="text-muted">Suba logos de partidos (PNG, JPG, GIF).</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Código del Partido:</label>
                            <input type="text" class="form-control" id="codigoPartidoLogo" placeholder="Ej: PART001">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Logo del Partido:</label>
                            <input type="file" class="form-control" id="logoPartido" accept="image/*">
                        </div>
                        
                        <button class="btn btn-primary" onclick="subirLogoPartido()">
                            <i class="bi bi-upload"></i> Subir Logo
                        </button>
                        
                        <div id="resultadoLogo" class="mt-3"></div>
                    </div>
                </div>

                <!-- Subir Fotos de Candidatos -->
                <div class="col-md-6 mb-4">
                    <div class="chart-card">
                        <h5 class="mb-3">
                            <i class="bi bi-person-square"></i> Fotos de Candidatos
                        </h5>
                        <p class="text-muted">Suba fotos de candidatos (PNG, JPG, GIF).</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Código del Candidato:</label>
                            <input type="text" class="form-control" id="codigoCandidatoFoto" placeholder="Ej: CAND001">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Foto del Candidato:</label>
                            <input type="file" class="form-control" id="fotoCandidato" accept="image/*">
                        </div>
                        
                        <button class="btn btn-primary" onclick="subirFotoCandidato()">
                            <i class="bi bi-upload"></i> Subir Foto
                        </button>
                        
                        <div id="resultadoFoto" class="mt-3"></div>
                    </div>
                </div>

                <!-- Guía de Uso -->
                <div class="col-12">
                    <div class="chart-card">
                        <h5 class="mb-3">
                            <i class="bi bi-info-circle"></i> Guía de Uso
                        </h5>
                        
                        <div class="accordion" id="guiaAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#guiaPartidos">
                                        Importar Partidos
                                    </button>
                                </h2>
                                <div id="guiaPartidos" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Campos del CSV:</strong></p>
                                        <ul>
                                            <li><code>codigo</code>: Código único del partido (Ej: PART001)</li>
                                            <li><code>nombre</code>: Nombre completo del partido</li>
                                            <li><code>sigla</code>: Sigla o abreviatura</li>
                                            <li><code>color_hex</code>: Color en formato hexadecimal (Ej: #FF0000)</li>
                                            <li><code>activo</code>: SI o NO</li>
                                            <li><code>tipo_eleccion_codigo</code>: Código del tipo de elección</li>
                                            <li><code>ambito_territorial</code>: nacional, departamental, municipal</li>
                                        </ul>
                                        <p><strong>Ejemplo:</strong></p>
                                        <code>PART001,Partido Liberal,PL,#FF0000,SI,PRES,nacional</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#guiaCandidatos">
                                        Importar Candidatos
                                    </button>
                                </h2>
                                <div id="guiaCandidatos" class="accordion-collapse collapse" data-bs-parent="#guiaAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Campos del CSV:</strong></p>
                                        <ul>
                                            <li><code>codigo</code>: Código único del candidato</li>
                                            <li><code>nombre</code>: Nombre completo</li>
                                            <li><code>partido_codigo</code>: Código del partido</li>
                                            <li><code>tipo_eleccion_codigo</code>: Tipo de elección</li>
                                            <li><code>numero_lista</code>: Número en la lista</li>
                                            <li><code>ambito_territorial</code>: nacional, departamental, municipal</li>
                                            <li><code>departamento_codigo</code>: Código del departamento (si aplica)</li>
                                            <li><code>municipio_codigo</code>: Código del municipio (si aplica)</li>
                                            <li><code>activo</code>: SI o NO</li>
                                        </ul>
                                        <p><strong>Ejemplo Municipal:</strong></p>
                                        <code>CAND001,Juan Pérez,PART001,CONC_MUN,5,municipal,18,001,SI</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

        <!-- ⭐ TAB: Personalización -->
        <div class="tab-pane fade" id="personalizacion" role="tabpanel">
            
            <!-- Header -->
            <div class="fondos-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-2"><i class="bi bi-palette"></i> Personalización del Sistema</h4>
                        <p class="text-muted mb-0">Personaliza la apariencia de la página de login</p>
                    </div>
                    <button class="btn btn-crear-fondo" onclick="personalizacion.mostrarFormularioCrear()">
                        <i class="bi bi-plus-circle"></i> Crear Nuevo Fondo
                    </button>
                </div>
            </div>

            <!-- Fondos Actuales -->
            <div class="fondos-section">
                <h5><i class="bi bi-images"></i> Fondos Actuales</h5>
                <div class="row" id="fondos-actuales">
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando fondos...</p>
                    </div>
                </div>
            </div>

            <!-- Fondos Predefinidos -->
            <div class="fondos-section">
                <h5><i class="bi bi-star"></i> Fondos Predefinidos</h5>
                <p class="text-muted small">Selecciona un fondo predefinido para usar rápidamente</p>
                <div class="row" id="fondos-predefinidos">
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando fondos predefinidos...</p>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- Modal: Crear Fondo -->
<div class="modal fade modal-personalizar" id="crearFondoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Crear Nuevo Fondo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <!-- Tabs para tipos de fondo -->
                <ul class="nav nav-tabs personalizacion-tabs mb-4" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-gradiente" data-bs-toggle="tab" data-bs-target="#crear-gradiente" type="button">
                            <i class="bi bi-palette"></i> Gradiente
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-imagen" data-bs-toggle="tab" data-bs-target="#crear-imagen" type="button">
                            <i class="bi bi-image"></i> Imagen
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-solido" data-bs-toggle="tab" data-bs-target="#crear-solido" type="button">
                            <i class="bi bi-square-fill"></i> Color Sólido
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    
                    <!-- Crear Gradiente -->
                    <div class="tab-pane fade show active" id="crear-gradiente" role="tabpanel">
                        <form id="form-gradiente">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Fondo</label>
                                <input type="text" class="form-control" id="gradiente-nombre" placeholder="Ej: Mi Gradiente Personalizado" required>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="color-picker-group">
                                        <label>Color 1:</label>
                                        <input type="color" class="form-control" id="gradiente-color1" value="#FCD116">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="color-picker-group">
                                        <label>Color 2:</label>
                                        <input type="color" class="form-control" id="gradiente-color2" value="#003893">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="color-picker-group">
                                        <label>Color 3:</label>
                                        <input type="color" class="form-control" id="gradiente-color3" value="#CE1126">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Dirección</label>
                                <select class="form-select" id="gradiente-direccion">
                                    <option value="180deg">Vertical (↓)</option>
                                    <option value="0deg">Vertical (↑)</option>
                                    <option value="90deg">Horizontal (→)</option>
                                    <option value="270deg">Horizontal (←)</option>
                                    <option value="135deg">Diagonal (↘)</option>
                                    <option value="45deg">Diagonal (↗)</option>
                                </select>
                            </div>

                            <!-- Preview -->
                            <div id="gradiente-preview" style="height: 150px; border-radius: 8px; margin-top: 1rem;"></div>

                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="personalizacion.crearFondoGradiente()">
                                <i class="bi bi-check-circle"></i> Crear Fondo con Gradiente
                            </button>
                        </form>
                    </div>

                    <!-- Subir Imagen -->
                    <div class="tab-pane fade" id="crear-imagen" role="tabpanel">
                        <form id="form-imagen">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Fondo</label>
                                <input type="text" class="form-control" id="imagen-nombre" placeholder="Ej: Paisaje de Colombia" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Seleccionar Imagen</label>
                                <input type="file" class="form-control" id="imagen-file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" required>
                                <small class="text-muted">Formatos: PNG, JPG, GIF, WEBP. Máximo 5MB</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Posición</label>
                                        <select class="form-select" id="imagen-posicion">
                                            <option value="center">Centro</option>
                                            <option value="top">Arriba</option>
                                            <option value="bottom">Abajo</option>
                                            <option value="left">Izquierda</option>
                                            <option value="right">Derecha</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Tamaño</label>
                                        <select class="form-select" id="imagen-tamano">
                                            <option value="cover">Cubrir (Cover)</option>
                                            <option value="contain">Contener (Contain)</option>
                                            <option value="auto">Automático</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div id="imagen-preview" style="height: 200px; border-radius: 8px; background-size: cover; background-position: center; display: none; margin-top: 1rem;"></div>

                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="personalizacion.subirImagenFondo()">
                                <i class="bi bi-upload"></i> Subir Imagen
                            </button>
                        </form>
                    </div>

                    <!-- Color Sólido -->
                    <div class="tab-pane fade" id="crear-solido" role="tabpanel">
                        <form id="form-solido">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Fondo</label>
                                <input type="text" class="form-control" id="solido-nombre" placeholder="Ej: Azul Institucional" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Seleccionar Color</label>
                                <div class="d-flex align-items-center gap-3">
                                    <input type="color" class="form-control" id="solido-color" value="#003893" style="width: 100px; height: 60px;">
                                    <input type="text" class="form-control" id="solido-color-hex" value="#003893" placeholder="#000000">
                                </div>
                            </div>

                            <!-- Preview -->
                            <div id="solido-preview" style="height: 150px; border-radius: 8px; background: #003893; margin-top: 1rem;"></div>

                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="personalizacion.crearFondoSolido()">
                                <i class="bi bi-check-circle"></i> Crear Fondo con Color Sólido
                            </button>
                        </form>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<!-- Modales se agregarán aquí -->

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/super-admin-dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/personalizacion-sistema.js') }}"></script>
<script>
// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    initSuperAdminDashboard();
    
    // Inicializar SyncManager
    if (window.syncManager) {
        window.syncManager.init();
    }
    
    // Inicializar módulo de personalización cuando se abre la pestaña
    const personalizacionTab = document.getElementById('personalizacion-tab');
    if (personalizacionTab) {
        personalizacionTab.addEventListener('shown.bs.tab', function() {
            if (window.personalizacion && !window.personalizacion.initialized) {
                window.personalizacion.init();
                window.personalizacion.initialized = true;
            }
        });
    }
    
    // Sincronizar color picker con input hex para color sólido
    const solidoColor = document.getElementById('solido-color');
    const solidoColorHex = document.getElementById('solido-color-hex');
    const solidoPreview = document.getElementById('solido-preview');
    
    if (solidoColor && solidoColorHex && solidoPreview) {
        solidoColor.addEventListener('input', function() {
            solidoColorHex.value = this.value;
            solidoPreview.style.background = this.value;
        });
        
        solidoColorHex.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                solidoColor.value = this.value;
                solidoPreview.style.background = this.value;
            }
        });
    }
});
</script>
{% endblock %}
