{% extends "base.html" %}

{% block title %}Dashboard Coordinador de Puesto{% endblock %}

{% block extra_css %}
<style>
.stats-card {
    border-left: 4px solid;
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.stats-card.pendientes {
    border-left-color: #ffc107;
}

.stats-card.validados {
    border-left-color: #28a745;
}

.stats-card.rechazados {
    border-left-color: #dc3545;
}

.stats-card.progreso {
    border-left-color: #007bff;
}

.image-preview-modal {
    max-height: 400px;
    overflow: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
    padding: 1rem;
}

.image-preview-modal img {
    max-width: 100%;
    height: auto;
    cursor: zoom-in;
}

.validation-alert {
    padding: 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.validation-alert.error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.validation-alert.warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.validation-alert.success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.split-view {
    display: flex;
    gap: 1rem;
}

.split-view-left {
    flex: 1;
}

.split-view-right {
    flex: 1;
}

.data-field {
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.data-field label {
    font-weight: 600;
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    display: block;
}

.data-field .value {
    font-size: 1rem;
    color: #212529;
}

.badge-status {
    font-size: 0.85rem;
    padding: 0.35rem 0.65rem;
}

/* Responsive */
@media (max-width: 768px) {
    .split-view {
        flex-direction: column;
    }
    
    .stats-card {
        margin-bottom: 0.75rem;
    }
    
    .table-responsive {
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>Dashboard - Coordinador de Puesto</h2>
            <p class="text-muted" id="puestoInfo">Cargando informaci칩n del puesto...</p>
        </div>
    </div>

    <!-- Estad칤sticas -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stats-card pendientes">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Pendientes</h6>
                    <h3 class="mb-0" id="statPendientes">0</h3>
                    <small class="text-muted">Por validar</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stats-card validados">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Validados</h6>
                    <h3 class="mb-0" id="statValidados">0</h3>
                    <small class="text-muted">Aprobados</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stats-card rechazados">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Rechazados</h6>
                    <h3 class="mb-0" id="statRechazados">0</h3>
                    <small class="text-muted">Devueltos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stats-card progreso">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Progreso</h6>
                    <h3 class="mb-0" id="statProgreso">0%</h3>
                    <small class="text-muted" id="statMesas">0 de 0 mesas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Pesta침as -->
    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="formularios-tab" data-bs-toggle="tab" data-bs-target="#formularios" type="button" role="tab">
                <i class="bi bi-file-earmark-text"></i> Formularios E-14
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="e24-tab" data-bs-toggle="tab" data-bs-target="#e24" type="button" role="tab">
                <i class="bi bi-table"></i> Consolidado E-24 Puesto
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabContent">
        <!-- Tab Formularios -->
        <div class="tab-pane fade show active" id="formularios" role="tabpanel">
            <div class="row">
                <!-- Tabla de Formularios -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Formularios E-14</h5>
                            <div class="btn-group btn-group-sm" role="group" id="filterButtons">
                                <button type="button" class="btn btn-outline-primary active" onclick="filtrarPorEstado('')">Todos</button>
                                <button type="button" class="btn btn-outline-warning" onclick="filtrarPorEstado('pendiente')">Pendientes</button>
                                <button type="button" class="btn btn-outline-success" onclick="filtrarPorEstado('validado')">Validados</button>
                                <button type="button" class="btn btn-outline-danger" onclick="filtrarPorEstado('rechazado')">Rechazados</button>
                            </div>
                        </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="formulariosTable">
                            <thead>
                                <tr>
                                    <th>Mesa</th>
                                    <th>Testigo</th>
                                    <th>Estado</th>
                                    <th>Total Votos</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="text-muted mt-2">Cargando formularios...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

                <!-- Panel Lateral -->
                <div class="col-lg-4">
                    <!-- Consolidado -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">Consolidado del Puesto</h5>
                        </div>
                        <div class="card-body" id="consolidadoPanel">
                            <p class="text-muted">Cargando consolidado...</p>
                        </div>
                    </div>

                    <!-- Lista de Mesas -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Estado de Mesas</h5>
                        </div>
                        <div class="card-body" id="mesasPanel">
                            <p class="text-muted">Cargando mesas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab E-24 Consolidado -->
        <div class="tab-pane fade" id="e24" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Consolidado E-24 del Puesto</h5>
                    <button class="btn btn-primary btn-sm" onclick="generarPDFE24()">
                        <i class="bi bi-file-pdf"></i> Generar PDF
                    </button>
                </div>
                <div class="card-body">
                    <!-- Resumen General -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Total Mesas</h6>
                                    <h3 id="e24TotalMesas">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Mesas Validadas</h6>
                                    <h3 id="e24MesasValidadas">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Total Votos</h6>
                                    <h3 id="e24TotalVotos">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Participaci칩n</h6>
                                    <h3 id="e24Participacion">0%</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Mesas con Votos -->
                    <h6 class="mb-3">Detalle por Mesa</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="e24Table">
                            <thead class="table-light">
                                <tr>
                                    <th>Mesa</th>
                                    <th>Testigo</th>
                                    <th>Estado</th>
                                    <th class="text-end">Votantes</th>
                                    <th class="text-end">Votos</th>
                                    <th class="text-end">V치lidos</th>
                                    <th class="text-end">Nulos</th>
                                    <th class="text-end">Blanco</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="table-secondary fw-bold">
                                <tr>
                                    <td colspan="3">TOTALES</td>
                                    <td class="text-end" id="e24FooterVotantes">0</td>
                                    <td class="text-end" id="e24FooterVotos">0</td>
                                    <td class="text-end" id="e24FooterValidos">0</td>
                                    <td class="text-end" id="e24FooterNulos">0</td>
                                    <td class="text-end" id="e24FooterBlanco">0</td>
                                    <td class="text-end" id="e24FooterParticipacion">0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Consolidado por Partido -->
                    <h6 class="mb-3 mt-4">Votos por Partido (Solo Mesas Validadas)</h6>
                    <div id="e24VotosPartidos">
                        <p class="text-muted">Cargando datos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Validaci칩n -->
<div class="modal fade" id="validacionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Validar Formulario E-14</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="split-view">
                    <!-- Imagen del formulario -->
                    <div class="split-view-left">
                        <h6 class="mb-3">游닞 Imagen del Formulario</h6>
                        <div class="image-preview-modal" id="imagenFormulario">
                            <p class="text-muted">No hay imagen disponible</p>
                        </div>
                    </div>

                    <!-- Datos digitados -->
                    <div class="split-view-right">
                        <h6 class="mb-3">游늵 Datos Digitados</h6>
                        
                        <!-- Informaci칩n de la mesa -->
                        <div class="mb-3">
                            <div class="data-field">
                                <label>Mesa</label>
                                <div class="value" id="valMesa">-</div>
                            </div>
                            <div class="data-field">
                                <label>Testigo</label>
                                <div class="value" id="valTestigo">-</div>
                            </div>
                        </div>

                        <!-- Datos de votaci칩n -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Datos de Votaci칩n</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnEditarDatos" onclick="habilitarEdicion()">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="data-field">
                                    <label>Votantes Registrados</label>
                                    <div class="value" id="valVotantesRegistrados">0</div>
                                    <input type="number" class="form-control form-control-sm d-none" id="editVotantesRegistrados" min="0" readonly>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="data-field">
                                    <label>Total Votos</label>
                                    <div class="value" id="valTotalVotos">0</div>
                                    <input type="number" class="form-control form-control-sm d-none" id="editTotalVotos" min="0">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="data-field">
                                    <label>Votos V치lidos</label>
                                    <div class="value" id="valVotosValidos">0</div>
                                    <input type="number" class="form-control form-control-sm d-none" id="editVotosValidos" min="0">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="data-field">
                                    <label>Votos Nulos</label>
                                    <div class="value" id="valVotosNulos">0</div>
                                    <input type="number" class="form-control form-control-sm d-none" id="editVotosNulos" min="0">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="data-field">
                                    <label>Votos en Blanco</label>
                                    <div class="value" id="valVotosBlanco">0</div>
                                    <input type="number" class="form-control form-control-sm d-none" id="editVotosBlanco" min="0">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="data-field">
                                    <label>Tarjetas No Marcadas</label>
                                    <div class="value" id="valTarjetasNoMarcadas">0</div>
                                    <input type="number" class="form-control form-control-sm d-none" id="editTarjetasNoMarcadas" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alerta de edici칩n -->
                        <div class="alert alert-warning py-2 d-none" id="alertaEdicion">
                            <small><i class="bi bi-info-circle"></i> Modo de edici칩n activado. Los cambios se registrar치n en el historial.</small>
                        </div>

                        <!-- Validaciones autom치ticas -->
                        <h6 class="mb-2">Validaciones Autom치ticas</h6>
                        <div id="validacionesAutomaticas">
                            <!-- Se llenar치n din치micamente -->
                        </div>

                        <!-- Votos por partido -->
                        <h6 class="mb-2 mt-3">Votos por Partido</h6>
                        <div id="votosPartidosList">
                            <!-- Se llenar치n din치micamente -->
                        </div>

                        <!-- Observaciones -->
                        <div class="mt-3">
                            <label class="form-label">Observaciones del Testigo</label>
                            <div class="data-field">
                                <div class="value" id="valObservaciones">Sin observaciones</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-danger" id="btnRechazar" onclick="mostrarModalRechazo()">
                    <i class="bi bi-x-circle"></i> Rechazar
                </button>
                <button type="button" class="btn btn-warning d-none" id="btnCancelarEdicion" onclick="cancelarEdicion()">
                    <i class="bi bi-x"></i> Cancelar Edici칩n
                </button>
                <button type="button" class="btn btn-success" id="btnValidar" onclick="validarFormulario()">
                    <i class="bi bi-check-circle"></i> Validar
                </button>
                <button type="button" class="btn btn-primary d-none" id="btnValidarConCambios" onclick="validarConCambios()">
                    <i class="bi bi-check-circle-fill"></i> Validar con Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Rechazo -->
<div class="modal fade" id="rechazoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rechazar Formulario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    El formulario ser치 devuelto al testigo para correcci칩n.
                </div>
                
                <div class="mb-3">
                    <label for="motivoRechazo" class="form-label">Motivo del Rechazo *</label>
                    <textarea class="form-control" id="motivoRechazo" rows="4" required 
                              placeholder="Explique claramente el motivo del rechazo..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Motivos Comunes:</label>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary text-start" 
                                onclick="seleccionarMotivo('Imagen borrosa o ilegible')">
                            Imagen borrosa o ilegible
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary text-start" 
                                onclick="seleccionarMotivo('Totales no coinciden con la suma de votos')">
                            Totales no coinciden con la suma de votos
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary text-start" 
                                onclick="seleccionarMotivo('Datos incompletos')">
                            Datos incompletos
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary text-start" 
                                onclick="seleccionarMotivo('Discrepancia entre imagen y datos digitados')">
                            Discrepancia entre imagen y datos digitados
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarRechazo()">
                    <i class="bi bi-x-circle"></i> Confirmar Rechazo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/coordinador-puesto.js') }}"></script>
{% endblock %}
