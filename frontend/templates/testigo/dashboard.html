{% extends "base.html" %}

{% block title %}Dashboard Testigo Electoral{% endblock %}

{% block extra_css %}
<style>
.image-preview {
    min-height: 150px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    background: #f8f9fa;
}

.image-preview img {
    max-width: 100%;
    max-height: 250px;
    border-radius: 4px;
}

.form-section {
    margin-bottom: 1rem;
}

.form-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
    font-size: 0.95rem;
}

/* Optimizaci√≥n para m√≥viles */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    .form-section h6 {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }
    
    .card {
        margin-bottom: 0.75rem !important;
    }
    
    .card-header h6 {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .input-group-text {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }
    
    .badge {
        font-size: 0.8rem;
    }
}

/* Cards de partidos m√°s compactos */
.card-header {
    padding: 0.75rem;
}

.card-body {
    padding: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Contenedor de alertas -->
    <div id="alert-container" class="mb-3"></div>
    
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div class="flex-grow-1">
                    <h2 class="mb-1">Dashboard - Testigo Electoral</h2>
                    <p class="text-muted mb-0 small">Bienvenido al sistema de recolecci√≥n de datos electorales</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.syncManager && window.syncManager.syncAll()" title="Sincronizar datos locales con el servidor">
                        <i class="bi bi-arrow-repeat"></i> <span class="d-none d-md-inline">Sincronizar</span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> <span class="d-none d-md-inline">Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pesta√±as de navegaci√≥n -->
    <ul class="nav nav-tabs mb-3 mb-md-4" id="testigoTabs" role="tablist" style="overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch;">
        <li class="nav-item" role="presentation" style="flex-shrink: 0;">
            <button class="nav-link active" id="formularios-tab" data-bs-toggle="tab" data-bs-target="#formularios" type="button" role="tab">
                <i class="bi bi-file-earmark-text"></i> <span class="d-none d-sm-inline">Formularios</span> E-14
            </button>
        </li>
        <li class="nav-item" role="presentation" style="flex-shrink: 0;">
            <button class="nav-link" id="incidentes-tab" data-bs-toggle="tab" data-bs-target="#incidentes" type="button" role="tab">
                <i class="bi bi-exclamation-triangle"></i> Incidentes
            </button>
        </li>
        <li class="nav-item" role="presentation" style="flex-shrink: 0;">
            <button class="nav-link" id="delitos-tab" data-bs-toggle="tab" data-bs-target="#delitos" type="button" role="tab">
                <i class="bi bi-shield-exclamation"></i> Delitos
            </button>
        </li>
    </ul>

    <!-- Contenido de las pesta√±as -->
    <div class="tab-content" id="testigoTabsContent">
        
        <!-- Tab 1: Formularios E-14 -->
        <div class="tab-pane fade show active" id="formularios" role="tabpanel">
            <!-- Selector de Mesa y Verificaci√≥n de Presencia -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Mesa</label>
                        <select class="form-select" id="mesa" required onchange="cambiarMesa()">
                            <option value="">Seleccione mesa...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Verificaci√≥n de Presencia</label>
                        <div id="presenciaContainer">
                            <button class="btn btn-success w-100" id="btnVerificarPresencia" onclick="verificarPresencia()">
                                <i class="bi bi-check-circle"></i> Verificar Mi Presencia en la Mesa
                            </button>
                            <div class="alert alert-success mt-2 d-none" id="alertaPresenciaVerificada">
                                <i class="bi bi-check-circle-fill"></i> Presencia verificada
                                <br><small id="presenciaFecha"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Tabla de Formularios -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Mis Formularios E-14</h5>
                            <button class="btn btn-primary" id="btnNuevoFormulario" onclick="showCreateForm()" disabled title="Debe seleccionar una mesa y verificar presencia primero">
                                <i class="bi bi-plus-circle"></i> Nuevo Formulario
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="formsTable">
                                    <thead>
                                        <tr>
                                            <th>Mesa</th>
                                            <th>Estado</th>
                                            <th>Total Votos</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <p class="text-muted">No hay formularios registrados</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel Lateral -->
                <div class="col-md-4">
                    <!-- Mesa Asignada -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Mi Mesa Asignada</h5>
                        </div>
                        <div class="card-body" id="assignedLocation">
                            <p class="text-muted">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Instrucciones -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Instrucciones</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>Tome una foto clara del formulario E-14</li>
                                <li>Digite todos los datos del formulario</li>
                                <li>Verifique que los totales coincidan</li>
                                <li>Env√≠e el formulario para revisi√≥n</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin Tab Formularios -->

        <!-- Tab 2: Incidentes y Problemas -->
        <div class="tab-pane fade" id="incidentes" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Incidentes Reportados</h5>
                            <button class="btn btn-warning" onclick="reportarIncidente()">
                                <i class="bi bi-plus-circle"></i> Reportar Incidente
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="incidentesLista">
                                <p class="text-muted text-center py-4">No hay incidentes reportados</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Tipos de Incidentes</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-check-circle text-warning"></i> Retraso en apertura</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-warning"></i> Falta de material electoral</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-warning"></i> Problemas t√©cnicos</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-warning"></i> Irregularidades en el proceso</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-warning"></i> Otros</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin Tab Incidentes -->

        <!-- Tab 3: Reporte de Delitos -->
        <div class="tab-pane fade" id="delitos" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Delitos Electorales Reportados</h5>
                            <button class="btn btn-danger" onclick="reportarDelito()">
                                <i class="bi bi-plus-circle"></i> Reportar Delito
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Importante:</strong> Los delitos electorales son graves. Reporte solo situaciones que constituyan una violaci√≥n clara de la ley electoral.
                            </div>
                            <div id="delitosLista">
                                <p class="text-muted text-center py-4">No hay delitos reportados</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Tipos de Delitos</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> Compra de votos</li>
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> Coacci√≥n al votante</li>
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> Fraude electoral</li>
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> Suplantaci√≥n de identidad</li>
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> Alteraci√≥n de resultados</li>
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> Otros delitos</li>
                            </ul>
                            <hr>
                            <p class="small text-muted">
                                <i class="bi bi-info-circle"></i>
                                Si presencia un delito electoral, rep√≥rtelo inmediatamente y contacte a las autoridades competentes.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin Tab Delitos -->

    </div>
    <!-- Fin Tab Content -->
</div>

<!-- Modal para crear/editar formulario E-14 -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Formulario E-14</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="e14Form" enctype="multipart/form-data">
                    <!-- Informaci√≥n B√°sica -->
                    <div class="form-section">
                        <h6>üìã Informaci√≥n B√°sica</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mesa *</label>
                                <select class="form-select" id="mesaFormulario" name="mesa_id" required onchange="cambiarMesaFormulario()">
                                    <option value="">Seleccione mesa...</option>
                                </select>
                                <small class="text-muted">Puedes cambiar de mesa si cubres varias</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo de Elecci√≥n *</label>
                                <select class="form-select" id="tipoEleccion" name="tipo_eleccion" required onchange="cargarPartidosYCandidatos()">
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Foto del Formulario -->
                    <div class="form-section">
                        <h6>üì∏ Foto del Formulario E-14</h6>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <input type="file" class="form-control d-none" id="imagen" name="imagen" accept="image/*" capture="environment">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('imagen').click()">
                                    <i class="bi bi-camera"></i> Tomar Foto / Seleccionar Imagen
                                </button>
                                <small class="text-muted d-block mt-1">Tome una foto clara del formulario completo</small>
                            </div>
                            <div class="col-12">
                                <div class="image-preview" id="imagePreview">
                                    <p class="text-muted">Toque el bot√≥n para tomar una foto</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de Votaci√≥n -->
                    <div class="form-section">
                        <h6>üó≥Ô∏è Datos de Votaci√≥n</h6>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-6 col-md-3">
                                        <div class="p-2 bg-primary bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-primary fw-bold">üìä Votantes Registrados</label>
                                            <input type="number" class="form-control form-control-sm border-primary bg-light" name="total_votantes_registrados" id="votantesRegistrados" min="0" readonly>
                                            <small class="text-muted">Autom√°tico</small>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="p-2 bg-danger bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-danger fw-bold">‚ùå Votos Nulos</label>
                                            <input type="number" class="form-control form-control-sm border-danger" name="votos_nulos" id="votosNulos" min="0" value="0" onchange="calcularTotales()" required>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="p-2 bg-secondary bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-secondary fw-bold">‚¨ú Votos en Blanco</label>
                                            <input type="number" class="form-control form-control-sm border-secondary" name="votos_blanco" id="votosBlanco" min="0" value="0" onchange="calcularTotales()" required>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="p-2 bg-warning bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-warning fw-bold">üìÑ Tarjetas No Marcadas</label>
                                            <input type="number" class="form-control form-control-sm border-warning" name="tarjetas_no_marcadas" id="tarjetasNoMarcadas" min="0" value="0" onchange="calcularTotales()" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-4">
                                        <div class="p-2 bg-success bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-success fw-bold">‚úÖ Votos V√°lidos</label>
                                            <input type="number" class="form-control form-control-sm border-success bg-light" name="votos_validos" id="votosValidos" min="0" readonly>
                                            <small class="text-muted">Autom√°tico</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 bg-info bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-info fw-bold">üìà Total Votos</label>
                                            <input type="number" class="form-control form-control-sm border-info bg-light" name="total_votos" id="totalVotos" min="0" readonly>
                                            <small class="text-muted">Autom√°tico</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 bg-dark bg-opacity-10 rounded">
                                            <label class="form-label small mb-1 text-dark fw-bold">üìã Total Tarjetas</label>
                                            <input type="number" class="form-control form-control-sm border-dark bg-light" name="total_tarjetas" id="totalTarjetas" readonly>
                                            <small class="text-muted">Autom√°tico</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Votos por Partido y Candidatos -->
                    <div class="form-section">
                        <h6>üó≥Ô∏è Votos por Partido y Candidatos</h6>
                        <div id="votacionContainer">
                            <p class="text-muted">Seleccione un tipo de elecci√≥n para cargar los partidos y candidatos</p>
                        </div>
                    </div>

                    <!-- Resumen Autom√°tico -->
                    <div class="form-section">
                        <h6>üìä Resumen de esta Mesa</h6>
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Total Votos en esta Mesa:</strong> <span id="resumenTotal">0</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Partido con m√°s votos:</strong> <span id="partidoGanador">-</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> 
                                        El candidato ganador se calcula a nivel municipal consolidando todos los E-14 (formulario E-24)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-section">
                        <h6>üìù Observaciones</h6>
                        <textarea class="form-control" name="observaciones" rows="3" placeholder="Ingrese cualquier observaci√≥n relevante sobre el proceso de votaci√≥n..."></textarea>
                    </div>
                    
                    <div class="validation-errors" id="validationErrors"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveForm('borrador')">
                    <i class="bi bi-save"></i> Guardar Borrador
                </button>
                <button type="button" class="btn btn-primary" onclick="saveForm('enviar')">
                    <i class="bi bi-send"></i> Enviar para Revisi√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para reportar incidente -->
<div class="modal fade" id="incidenteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reportar Incidente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formIncidente">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Incidente *</label>
                        <select class="form-select" id="tipoIncidente" name="tipo_incidente" required>
                            <option value="">Seleccione tipo de incidente...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T√≠tulo *</label>
                        <input type="text" class="form-control" name="titulo" required placeholder="Ej: Falta de boletas en mesa 123">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Severidad *</label>
                        <select class="form-select" name="severidad" required>
                            <option value="baja">Baja</option>
                            <option value="media" selected>Media</option>
                            <option value="alta">Alta</option>
                            <option value="critica">Cr√≠tica</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n *</label>
                        <textarea class="form-control" name="descripcion" rows="4" required placeholder="Describa el incidente con el mayor detalle posible..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="guardarIncidente()">
                    <i class="bi bi-send"></i> Reportar Incidente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para reportar delito -->
<div class="modal fade" id="delitoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Reportar Delito Electoral</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Advertencia:</strong> Este reporte ser√° enviado a las autoridades electorales competentes.
                </div>
                <form id="formDelito">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Delito *</label>
                        <select class="form-select" id="tipoDelito" name="tipo_delito" required>
                            <option value="">Seleccione tipo de delito...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T√≠tulo *</label>
                        <input type="text" class="form-control" name="titulo" required placeholder="Ej: Intento de compra de votos">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gravedad *</label>
                        <select class="form-select" name="gravedad" required>
                            <option value="leve">Leve</option>
                            <option value="media" selected>Media</option>
                            <option value="grave">Grave</option>
                            <option value="muy_grave">Muy Grave</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n Detallada *</label>
                        <textarea class="form-control" name="descripcion" rows="5" required placeholder="Describa el delito con el mayor detalle posible: qu√© ocurri√≥, qui√©nes estuvieron involucrados, cu√°ndo sucedi√≥, etc."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Testigos Adicionales (opcional)</label>
                        <input type="text" class="form-control" name="testigos_adicionales" placeholder="Nombres de otros testigos presenciales">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="guardarDelito()">
                    <i class="bi bi-send"></i> Reportar Delito
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/incidentes-delitos.js') }}"></script>
<script src="{{ url_for('static', filename='js/testigo-dashboard-v2.js') }}"></script>
<script src="{{ url_for('static', filename='js/testigo-presencia-simple.js') }}"></script>
{% endblock %}
