{% extends "base.html" %}

{% block title %}Dashboard Municipal - Sistema Electoral{% endblock %}

{% block extra_css %}
<style>
    .progress-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        margin-bottom: 2rem;
    }
    
    .progress-stat {
        text-align: center;
    }
    
    .progress-stat-value {
        font-size: 3rem;
        font-weight: var(--font-weight-bold);
        line-height: 1;
    }
    
    .progress-stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
        margin-top: 0.5rem;
    }
    
    .progress-bar-custom {
        height: 2rem;
        border-radius: var(--border-radius-md);
        background: rgba(255, 255, 255, 0.2);
        overflow: hidden;
        margin-top: 1rem;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-weight-semibold);
        color: #667eea;
        transition: width 0.5s ease;
    }
    
    .ranking-table {
        width: 100%;
    }
    
    .ranking-table th {
        background: var(--color-light);
        padding: 0.75rem;
        font-weight: var(--font-weight-semibold);
        border-bottom: 2px solid var(--color-gray-light);
    }
    
    .ranking-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--color-gray-light);
    }
    
    .ranking-position {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-weight-bold);
        color: white;
    }
    
    .ranking-position--1 { background: #ffd700; color: #000; }
    .ranking-position--2 { background: #c0c0c0; color: #000; }
    .ranking-position--3 { background: #cd7f32; color: #fff; }
    .ranking-position--default { background: var(--color-gray); }
    
    .participation-bar {
        height: 8px;
        background: var(--color-gray-light);
        border-radius: var(--border-radius-full);
        overflow: hidden;
    }
    
    .participation-fill {
        height: 100%;
        border-radius: var(--border-radius-full);
        transition: width 0.3s ease;
    }
    
    .participation-fill--high { background: #10b981; }
    .participation-fill--medium { background: #f59e0b; }
    .participation-fill--low { background: #ef4444; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="dashboard-title mb-2">Dashboard Municipal</h1>
        <p class="dashboard-subtitle mb-0">
            <span id="municipio-name">Municipio</span> • 
            <span id="departamento-name">Departamento</span>
        </p>
    </div>
    
    <!-- Progress Overview -->
    <div class="progress-overview">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="mb-3">Progreso de Reporte</h3>
                <div class="progress-bar-custom">
                    <div class="progress-bar-fill" id="progress-bar" style="width: 0%">
                        <span id="progress-text">0%</span>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-4">
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="puestos-reportados">0</div>
                            <div class="progress-stat-label">Puestos Reportados</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="puestos-total">0</div>
                            <div class="progress-stat-label">Total Puestos</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="tiempo-restante">--</div>
                            <div class="progress-stat-label">Tiempo desde cierre</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <canvas id="progress-chart" width="200" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map and Stats -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="dashboard-card">
                <div class="dashboard-card__header">
                    <h3 class="dashboard-card__title">
                        <i class="bi bi-map"></i> Mapa del Municipio
                    </h3>
                </div>
                <div class="dashboard-card__body">
                    <div id="municipio-map" style="height: 500px; border-radius: var(--border-radius-md);"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="dashboard-card mb-3">
                <div class="dashboard-card__header">
                    <h3 class="dashboard-card__title">Votos Consolidados</h3>
                </div>
                <div class="dashboard-card__body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Total Votantes</span>
                            <strong id="total-votantes">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Total Votos</span>
                            <strong id="total-votos">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Participación</span>
                            <strong id="participacion">0%</strong>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mb-2">Distribución de Votos</h6>
                    <canvas id="votos-chart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-card">
                <div class="dashboard-card__header">
                    <h3 class="dashboard-card__title">Alertas Activas</h3>
                </div>
                <div class="dashboard-card__body">
                    <div id="alertas-summary">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ranking Table -->
    <div class="dashboard-card mb-4">
        <div class="dashboard-card__header">
            <h3 class="dashboard-card__title">
                <i class="bi bi-trophy"></i> Ranking de Puestos
            </h3>
            <div class="dashboard-card__actions">
                <select class="form-select form-select-sm" id="ranking-sort" onchange="sortRanking()">
                    <option value="participacion">Por Participación</option>
                    <option value="reportados">Por Formularios Reportados</option>
                    <option value="nombre">Por Nombre</option>
                </select>
            </div>
        </div>
        <div class="dashboard-card__body">
            <div class="table-responsive">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>Puesto</th>
                            <th style="text-align: center;">Mesas</th>
                            <th style="text-align: center;">Reportados</th>
                            <th style="width: 200px;">Participación</th>
                            <th style="text-align: center;">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-tbody">
                        <!-- Ranking rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Puestos Sin Reportar -->
    <div class="dashboard-card">
        <div class="dashboard-card__header">
            <h3 class="dashboard-card__title">
                <i class="bi bi-exclamation-triangle text-danger"></i> Puestos Sin Reportar
            </h3>
        </div>
        <div class="dashboard-card__body">
            <div id="sin-reportar-list">
                <!-- List will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Export Button -->
    <div class="text-end mt-4">
        <button class="btn btn-primary btn-lg" onclick="exportReport()">
            <i class="bi bi-file-pdf"></i> Exportar Reporte Municipal
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    let municipioData = null;
    let progressChart = null;
    let votosChart = null;
    let municipioMap = null;
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadMunicipioData();
        initializeMap();
        setupAutoRefresh();
    });
    
    /**
     * Load municipio data
     */
    async function loadMunicipioData() {
        try {
            const response = await APIClient.get('/coordination/municipio/dashboard');
            
            if (response.success && response.data) {
                municipioData = response.data;
                renderDashboard(municipioData);
            }
        } catch (error) {
            console.error('Error loading municipio data:', error);
            Utils.showAlert('Error al cargar datos del municipio', 'danger');
        }
    }
    
    /**
     * Render dashboard
     */
    function renderDashboard(data) {
        // Update header
        document.getElementById('municipio-name').textContent = data.municipio_nombre;
        document.getElementById('departamento-name').textContent = data.departamento_nombre;
        
        // Update progress
        const percentage = data.puestos_total > 0 
            ? (data.puestos_reportados / data.puestos_total * 100).toFixed(1)
            : 0;
        
        document.getElementById('puestos-reportados').textContent = data.puestos_reportados;
        document.getElementById('puestos-total').textContent = data.puestos_total;
        document.getElementById('progress-text').textContent = percentage + '%';
        document.getElementById('progress-bar').style.width = percentage + '%';
        
        // Update time
        if (data.hora_cierre) {
            const elapsed = calculateElapsedTime(data.hora_cierre);
            document.getElementById('tiempo-restante').textContent = elapsed;
        }
        
        // Update consolidated votes
        document.getElementById('total-votantes').textContent = Utils.formatNumber(data.total_votantes || 0);
        document.getElementById('total-votos').textContent = Utils.formatNumber(data.total_votos || 0);
        const participacion = data.total_votantes > 0 
            ? (data.total_votos / data.total_votantes * 100).toFixed(1)
            : 0;
        document.getElementById('participacion').textContent = participacion + '%';
        
        // Render charts
        renderProgressChart(data.puestos_reportados, data.puestos_total);
        renderVotosChart(data.votos_partidos || {});
        
        // Render ranking
        renderRanking(data.puestos || []);
        
        // Render sin reportar
        renderSinReportar(data.puestos_sin_reportar || []);
        
        // Render alerts
        renderAlertsSummary(data.alertas_activas || []);
    }
    
    /**
     * Calculate elapsed time
     */
    function calculateElapsedTime(cierreTime) {
        const now = new Date();
        const cierre = new Date(cierreTime);
        const diff = now - cierre;
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        return `${hours}h ${minutes}m`;
    }
    
    /**
     * Render progress chart
     */
    function renderProgressChart(reportados, total) {
        const ctx = document.getElementById('progress-chart').getContext('2d');
        
        if (progressChart) {
            progressChart.destroy();
        }
        
        progressChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Reportados', 'Pendientes'],
                datasets: [{
                    data: [reportados, total - reportados],
                    backgroundColor: ['#ffffff', 'rgba(255, 255, 255, 0.3)'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    /**
     * Render votos chart
     */
    function renderVotosChart(partidos) {
        const ctx = document.getElementById('votos-chart').getContext('2d');
        
        if (votosChart) {
            votosChart.destroy();
        }
        
        const labels = Object.keys(partidos);
        const data = Object.values(partidos);
        
        votosChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votos',
                    data: data,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    /**
     * Render ranking
     */
    function renderRanking(puestos) {
        const tbody = document.getElementById('ranking-tbody');
        
        tbody.innerHTML = puestos.map((puesto, index) => {
            const position = index + 1;
            const positionClass = position <= 3 ? `ranking-position--${position}` : 'ranking-position--default';
            const participacion = puesto.total_votantes > 0 
                ? (puesto.total_votos / puesto.total_votantes * 100).toFixed(1)
                : 0;
            const participacionClass = participacion >= 70 ? 'high' : participacion >= 40 ? 'medium' : 'low';
            
            return `
                <tr>
                    <td>
                        <div class="ranking-position ${positionClass}">
                            ${position}
                        </div>
                    </td>
                    <td>
                        <strong>${puesto.nombre}</strong>
                    </td>
                    <td style="text-align: center;">
                        ${puesto.total_mesas || 0}
                    </td>
                    <td style="text-align: center;">
                        <strong>${puesto.formularios_reportados || 0}</strong> / ${puesto.total_mesas || 0}
                    </td>
                    <td>
                        <div class="participation-bar">
                            <div class="participation-fill participation-fill--${participacionClass}" 
                                 style="width: ${participacion}%"></div>
                        </div>
                        <small class="text-muted">${participacion}%</small>
                    </td>
                    <td style="text-align: center;">
                        <span class="badge bg-${puesto.estado === 'completo' ? 'success' : 'warning'}">
                            ${puesto.estado}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    /**
     * Render sin reportar
     */
    function renderSinReportar(puestos) {
        const container = document.getElementById('sin-reportar-list');
        
        if (puestos.length === 0) {
            container.innerHTML = '<p class="text-success"><i class="bi bi-check-circle"></i> Todos los puestos han reportado</p>';
            return;
        }
        
        container.innerHTML = puestos.map(puesto => `
            <div class="alert alert-warning mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${puesto.nombre}</strong>
                        <br>
                        <small>${puesto.total_mesas || 0} mesas sin reportar</small>
                    </div>
                    <a href="/coordinador/puesto/${puesto.id}" class="btn btn-sm btn-warning">
                        Ver Detalle
                    </a>
                </div>
            </div>
        `).join('');
    }
    
    /**
     * Render alerts summary
     */
    function renderAlertsSummary(alertas) {
        const container = document.getElementById('alertas-summary');
        
        if (alertas.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay alertas activas</p>';
            return;
        }
        
        container.innerHTML = alertas.slice(0, 5).map(alerta => `
            <div class="mb-2 pb-2 border-bottom">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>${alerta.titulo}</strong>
                        <br>
                        <small class="text-muted">${alerta.mensaje.substring(0, 50)}...</small>
                    </div>
                    <span class="badge bg-${alerta.severidad === 'critica' ? 'danger' : 'warning'}">
                        ${alerta.severidad}
                    </span>
                </div>
            </div>
        `).join('');
        
        if (alertas.length > 5) {
            container.innerHTML += `
                <a href="/coordinador/alertas" class="btn btn-sm btn-link">
                    Ver todas (${alertas.length})
                </a>
            `;
        }
    }
    
    /**
     * Initialize map
     */
    function initializeMap() {
        if (typeof LocationMap === 'undefined') return;
        
        municipioMap = new LocationMap('municipio-map', {
            enableClustering: true,
            showLegend: true,
            autoFitBounds: true
        });
        
        if (municipioMap.initialize()) {
            municipioMap.loadLocations('/locations/puestos-municipio');
        }
    }
    
    /**
     * Sort ranking
     */
    window.sortRanking = function() {
        // Reload data with new sort
        loadMunicipioData();
    };
    
    /**
     * Export report
     */
    window.exportReport = async function() {
        try {
            Utils.showAlert('Generando reporte...', 'info');
            
            const response = await APIClient.get('/coordination/municipio/report', { responseType: 'blob' });
            
            if (response) {
                const url = window.URL.createObjectURL(response);
                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte-municipal-${Date.now()}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                Utils.showAlert('Reporte descargado exitosamente', 'success');
            }
        } catch (error) {
            console.error('Error exporting report:', error);
            Utils.showAlert('Error al generar reporte', 'danger');
        }
    };
    
    /**
     * Setup auto-refresh
     */
    function setupAutoRefresh() {
        setInterval(() => {
            loadMunicipioData();
        }, 60000); // Refresh every minute
    }
</script>
{% endblock %}
